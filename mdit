#!/bin/bash
# MarkDownIum Terminal client (MDIT)
# this code is MIT licenced
# by TheOddCell

# WebPath and URL parsing
set -o pipefail
trap 'printf "\033[0m";clear;exec $0 sidebar' INT
trap 'printf "\033[0m";clear;exec $0 $WEBPATH --automore' TSTP
tput smcup
clear
WEBPATH="$1"
: "${WEBPATH:=home}"
if [ "$WEBPATH" == "/" ]; then
  WEBPATH="/home"
fi
case "$WEBPATH" in
  http://*|https://*)
    xdg-open "$WEBPATH"
    WEBPATH="/home"
    ;;
  /*)
    ;;
  *)
    WEBPATH="/$WEBPATH"
    ;;
esac
# config.json
: "${CONFIGDOTJSON:=https://wiki.obsidianos.xyz/config.json}"
URL="$(curl -fsSL $CONFIGDOTJSON | jq -r '.baseUrl')"
LOGO="$(curl -fsSL $CONFIGDOTJSON | jq -r '.logo')"
NAME="$(curl -fsSL $CONFIGDOTJSON | jq -r '.siteName')"
LICENCE="$(curl -fsSL $CONFIGDOTJSON | jq -r '.licenseBadge')"
WIDTH=${COLUMNS:-80};HEIGHT=${LINES:-24};BG=44;FG=97
# styling
format_text() {
  sed -E '
  # Replace %GAP% with |
  s/%GAP%/|/g

  # Markdown links: [text](url) -> text [url], no color
  s/\[([^]]*)\]\(([^)]*)\)/\1 [\2]/g

  # Headers: #, ##, ###, #### -> yellow
  s/^(#{1,4}) (.*)/\x1b[33m\2\x1b[0m/

  # Quote line: "> " to "| "
  s/^> /| /

  # Bold: **text** (does not clear color)
  s/\*\*([^*]+)\*\*/\x1b[1m\1\x1b[22m/g

  # Italic: *text* (does not clear color)
  s/\*([^*]+)\*/\x1b[3m\1\x1b[23m/g

  # Inline code: `text` -> grey bg, white text
  s/`([^`]+)`/\x1b[100;97m\1\x1b[0m/g
  '
}
# top bar
topbar() {
  LICENCETEXT="$(printf '%s\n' "$LICENCE" \
    | sed -n 's/.*alt="\([^"]*\)".*/ - \1/p')"
  if [ "$WEBPATH" = "/home" ]; then
    WEBPATH2="/"
  else
    WEBPATH2="$WEBPATH"
  fi
  TEXT2="$1"
  if [ -z "$1"             ]; then TEXT2="MDIT - [+OK] - [$NAME]$WEBPATH2$LICENCETEXT";fi
  if [    "$1" = "loading" ]; then TEXT2="MDIT - [...] - [$NAME]$WEBPATH2$LICENCETEXT";fi
  if [    "$1" = "error"   ]; then TEXT2="MDIT - [!!!] - [$NAME]$WEBPATH2$LICENCETEXT";fi
  PAD=$((WIDTH - ${#TEXT2}))
  printf "\033[H\033[${BG}m\033[1;${FG}m%s%${PAD}s\033[0m\n" "$TEXT2" ""
}
topbar loading
# rendering
also0="$0"
moreable() {
  if [ "$1" = "--automore" ]; then
    if command -v most >/dev/null; then
      most
    elif command -v less >/dev/null; then
      less --use-color
    fi
    tput smcup
    clear
    topbar
    curl -fsSL "$LOGO" 2>/dev/null|kitten icat --align=left -n --use-window-size 50,50,50,50 --detection-timeout=0.1 2>/dev/null
    printf " $NAME | "
    curl -fsSL "$URL/top.md"|format_text
    if [ "$?" != "0" ]; then topbar error; fi
    curl -fsSL "$URL/$WEBPATH.md"|format_text
    if [ "$?" != "0" ]; then topbar error; fi
  else
    more
    printf "\033[H"
    topbar
  fi
}
curl -fsSL "$LOGO" 2>/dev/null|kitten icat --align=left -n --use-window-size 50,50,50,50 --detection-timeout=0.1 2>/dev/null
printf " $NAME | "
curl -fsSL "$URL/top.md"|format_text
if [ "$?" != "0" ]; then topbar error; fi
curl -fsSL "$URL/$WEBPATH.md"|format_text|moreable "$2"
if [ "$?" != "0" ]; then topbar error; fi
# help bar
printf "\033[${HEIGHT};1H"
  TEXT="^C sidebar ^D reload ^C^C exit            , or type path:"
if command -v most >/dev/null; then
  TEXT="^C sidebar ^D reload ^C^C exit ^Z use most, or type path:"
elif command -v less >/dev/null; then
  TEXT="^C sidebar ^D reload ^C^C exit ^Z use less, or type path:"
fi
if [ "$WEBPATH" = "/sidebar" ]; then 
  trap 'clear;tput rmcup; exit 0' INT
    TEXT="^C exit    ^D reload                      , or type path:"
  if command -v most >/dev/null; then
    TEXT="^C exit    ^D reload           ^Z use most, or type path:"
  elif command -v less >/dev/null; then
    TEXT="^C exit    ^D reload           ^Z use less, or type path:"
  fi
fi
PAD=$((WIDTH - ${#TEXT}))
LENGTH=$((${#TEXT} + 2))
printf "\033[${BG}m\033[1;${FG}m%s%${PAD}s" "$TEXT" ""
# input parsing
printf "\033[${HEIGHT};${LENGTH}H"
read input
printf "\033[0m"
clear
if [ -n "$input" ]; then
  exec $0 "$input"
fi
exec $0 "$WEBPATH"
